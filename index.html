<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gameficação</title>
    <link rel="icon" href="https://uploaddeimagens.com.br/images/004/814/521/full/gamefica%C3%A7%C3%A3o-icon_%281%29.png?1721856203" type="image/png">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <style>
 :root {
    --background-color: #f1f3f4;
    --text-color: #333;
    --container-background-color: #ffffff;
    --button-background-color: #007bff;
    --button-text-color: #fff;
    --button-hover-background-color: #0056b3;
    --google-button-background-color: #db4437;
    --input-border-color: #ccc;
    --notification-error-background-color: #f8d7da;
    --notification-error-text-color: #721c24;
    --notification-error-border-color: #f5c6cb;
    --notification-success-background-color: #d4edda;
    --notification-success-text-color: #155724;
    --notification-success-border-color: #c3e6cb;
    --category-button-background-color: #f8f9fa;
    --category-button-border-color: #007bff;
    --category-button-text-color: #007bff;
    --post-border-color: #ddd;
    --post-link-color: #1a73e8;
    --header-background-color: #333;
    --header-text-color: #fff;
    --header-border-color: #f8f9fa;
    --header-shadow: rgba(0, 0, 0, 0.1);
}

body {
    font-family: Arial, sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.container {
    width: 90%;
    max-width: 800px;
    margin: 20px auto;
    padding: 20px;
    background: var(--container-background-color);
    box-shadow: 0 2px 10px var(--header-shadow);
    border-radius: 8px;
}

#post-title {
    font-size: 30px;
}

#post-author-date {
    font-size: 15px;
}

#post-content {
    margin: 50px 0px;
}

button {
    padding: 10px;
    background-color: var(--button-background-color);
    color: var(--button-text-color);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin: 10px 0;
    transition: background-color 0.3s;
}

button:hover {
    background-color: var(--button-hover-background-color);
}

.google-login-button {
    background-color: var(--google-button-background-color);
    color: var(--button-text-color);
}

#category-select {
    padding: 10px;
    border-radius: 4px;
    border: 1px solid var(--input-border-color);
    margin: 10px 0;
    font-size: 16px;
}

#notification {
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 4px;
    display: none;
}

#notification.error {
    background-color: var(--notification-error-background-color);
    color: var(--notification-error-text-color);
    border: 1px solid var(--notification-error-border-color);
}

#notification.success {
    background-color: var(--notification-success-background-color);
    color: var(--notification-success-text-color);
    border: 1px solid var(--notification-success-border-color);
}

.section {
    display: none;
}

.visible {
    display: block;
}

h2 {
    margin-top: 0;
}

input, textarea {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    border: 1px solid var(--input-border-color);
    box-sizing: border-box;
}

#category-buttons-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.category-button {
    display: flex;
    padding: 30px;
    border-radius: 8px;
    border: 2px solid var(--category-button-border-color);
    background-color: var(--category-button-background-color);
    color: var(--category-button-text-color);
    font-size: 18px;
    cursor: pointer;
    align-items: center;
    transition: background-color 0.3s, color 0.3s;
}

.category-button:hover {
    background-color: var(--category-button-border-color);
    color: #fff;
}

.category-button:active {
    background-color: var(--button-hover-background-color);
}

.post {
    border: 5px solid var(--post-border-color);
    padding: 16px;
    margin-bottom: 16px;
    border-radius: 4px;
}

#comments-container {
    margin-bottom: 30px;
}

.comment-wrapper {
    border: 5px solid var(--post-border-color);
    padding: 10px;
}

.post:hover {
    cursor: pointer;
}

.post-header {
    font-weight: bold;
    margin-bottom: 5px;
}

.ql-editor img {
    height: 50%;
    width: 50%;
}

@media screen and (max-width: 600px) {
  #header {
    justify-content: center;
    flex-direction: column;
  }
  .logo-container {
    margin: 50px;
  }
}

.post a {
    color: var(--post-link-color);
}

.logo-container {
    display: flex;
    align-items: center;
}

.logo {
    height: 40px;
    margin-right: 10px;
}

h1 {
    margin: 0;
    font-size: 24px;
}

#user-info {
    display: flex;
    align-items: center;
}

#user-info h2 {
    margin: 0;
    margin-right: 20px;
}

#user-info button {
    padding: 10px 20px;
    background-color: #fff;
    color: var(--button-background-color);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background-color 0.3s;
}

#user-info button:hover {
    background-color: var(--background-color);
}

.site-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: var(--header-background-color);
    color: var(--header-text-color);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 10px 20px;
    z-index: 1000;
}

.header-content {
    display: flex;
    align-items: center;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
}

.logo img {
    height: 50px;
    margin-right: 15px;
}

.site-title {
    font-size: 24px;
    margin: 0;
}

body {
    padding-top: 70px;
}

#header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    width: 90%;
    background-color: var(--header-background-color);
    box-shadow: 0 2px 4px var(--header-shadow);
    margin-bottom: 50px;
}

:root {
    --logo-color: #36be24; /* Cor padrão do logo */
}

.logo-container {
    display: flex;
    align-items: center;
}

.logo {
    height: 50px; /* Ajuste o tamanho conforme necessário */
    width: 50px;
    fill: var(--logo-color); /* Usa a variável CSS para a cor */
}


#header h1 {
    font-size: 24px;
    color: var(--text-color);
    margin: 0;
}

#user-info {
    display: flex;
    align-items: center;
}

#user-info h2 {
    font-size: 18px;
    margin-right: 20px;
}

#user-info button {
    padding: 10px 15px;
    font-size: 16px;
    border: none;
    border-radius: 5px;
    background-color: var(--button-background-color);
    color: var(--button-text-color);
    cursor: pointer;
    transition: background-color 0.3s;
}

#user-info button:hover {
    background-color: var(--button-hover-background-color);
}

.comment-wrapper {
    margin-bottom: 20px;
}

.comment-header {
    font-size: 14px;
    color: #555;
    margin-bottom: 5px;
}

.comment-header strong {
    font-weight: bold;
}

.category-icon {
    width: 100px; height: 100px;
    margin-right: 50px;
}

    </style>
</head>
<body>
    <!-- Seção de Cabeçalho -->
<div id="header">
    <div class="logo-container">
        <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
        width="630" height="630" viewBox="0 0 630 630"
        preserveAspectRatio="xMidYMid meet" class="logo">
       <g transform="translate(0.000000,630.000000) scale(0.100000,-0.100000)"
         stroke="none">
           <path d="M1585 5272 c-143 -38 -269 -73 -280 -79 -54 -29 -95 -102 -95 -168 0 -89 60 -163 148 -185 48 -11 62 -8 327 59 152 39 290 78 306 86 44 23 82 87 87 149 6 73 -22 135 -78 172 -71 47 -117 44 -415 -34z"/>
           <path d="M4330 5329 c-81 -32 -126 -109 -118 -199 6 -58 44 -122 87 -144 16 -9 156 -47 312 -86 268 -67 285 -70 331 -59 147 35 197 211 91 321 -34 36 -41 38 -340 113 -261 65 -315 73 -363 54z"/>
           <path d="M2700 4829 c-536 -28 -1249 -143 -1456 -235 -164 -72 -321 -230 -389 -389 -174 -411 -320 -1109 -380 -1820 -25 -291 -16 -424 39 -588 102 -304 359 -560 771 -768 107 -54 128 -61 196 -66 145 -11 258 36 380 157 95 94 177 218 279 426 44 89 91 175 105 192 14 17 49 42 77 56 l52 26 776 0 776 0 52 -26 c28 -14 63 -39 77 -56 14 -17 61 -103 105 -192 102 -208 184 -332 279 -426 168 -167 346 -203 539 -110 264 126 516 317 650 492 137 179 212 402 212 630 0 152 -40 557 -81 823 -74 490 -195 968 -314 1250 -67 158 -226 317 -389 389 -160 71 -728 175 -1176 216 -322 29 -839 37 -1180 19z m810 -379 c428 -21 816 -71 1185 -151 185 -41 234 -60 299 -120 74 -68 99 -114 161 -302 146 -443 247 -990 295 -1602 13 -167 5 -265 -32 -364 -72 -192 -256 -368 -550 -526 l-88 -47 -34 21 c-68 42 -146 162 -268 411 -76 156 -85 170 -162 246 -60 59 -102 91 -157 117 -152 75 -110 72 -1009 72 -899 0 -857 3 -1009 -72 -55 -26 -97 -58 -157 -117 -77 -76 -86 -90 -162 -246 -122 -249 -200 -369 -268 -411 l-34 -21 -88 47 c-293 158 -476 331 -547 519 -41 110 -49 190 -35 366 47 613 147 1159 295 1607 62 188 87 234 161 302 65 60 114 79 299 120 588 128 1272 182 1905 151z"/>
           <path d="M4029 3872 c-232 -121 -143 -473 120 -472 83 0 132 22 188 82 86 95 86 241 0 336 -56 60 -105 82 -188 82 -54 0 -77 -5 -120 -28z"/>
           <path d="M1562 3819 c-56 -28 -94 -84 -100 -148 -8 -85 9 -114 154 -261 l133 -136 -125 -124 c-68 -69 -133 -143 -144 -166 -58 -119 19 -259 149 -272 85 -8 114 9 261 154 l136 133 124 -125 c69 -68 143 -133 166 -144 119 -58 259 19 272 149 8 85 -9 114 -154 261 l-133 136 125 124 c68 69 133 143 144 166 58 119 -19 259 -149 272 -85 8 -114 -9 -261 -154 l-136 -133 -124 125 c-69 68 -143 133 -166 144 -53 26 -118 25 -172 -1z"/>
           <path d="M4529 3122 c-232 -121 -143 -473 120 -472 83 0 132 22 188 82 86 95 86 241 0 336 -56 60 -105 82 -188 82 -54 0 -77 -5 -120 -28z"/>
       </g>
   </svg>
        <h1>Gameficação</h1>
    </div>
    <div id="user-info" class="section" display="none">
        <h2>Bem-vindo, <span id="user-name">Usuário</span></h2>
        <button onclick="logout()">Sair</button>
    </div>
</div>
    <div class="container">
        <div id="notification"></div>


        <!-- Seção de Login -->
        <div id="login-section" class="section visible">
            <h2>Login</h2>
            <input type="text" id="login-username" placeholder="Nome de usuário ou Email" aria-label="Nome de usuário ou Email">
            <input type="password" id="login-password" placeholder="Senha" aria-label="Senha">
            <button onclick="login()">Entrar</button>
            <button class="google-login-button" onclick="loginWithGoogle()">Login com Google</button>
            <p>Não tem uma conta? <a href="javascript:void(0)" onclick="showRegistration()">Registre-se</a></p>
            <div class="password-reset">
                <a href="#" id="reset-password-link">Esqueceu sua senha?</a>
              </div>              
        </div>

        <!-- Seção de Registro -->
        <div id="registration-section" class="section">
            <h2>Registro</h2>
            <input type="text" id="register-username" placeholder="Nome de usuário" aria-label="Nome de usuário">
            <input type="email" id="register-email" placeholder="Email" aria-label="Email">
            <input type="password" id="register-password" placeholder="Senha" aria-label="Senha">
            <button onclick="register()">Registrar</button>
            <p>Já tem uma conta? <a href="javascript:void(0)" onclick="showLogin()">Faça login</a></p>
        </div>

        <!-- Seção de Definir Nome de Usuário -->
        <div id="set-username-section" class="section">
            <h2>Definir Nome de Usuário</h2>
            <input type="text" id="new-username" placeholder="Nome de usuário" aria-label="Nome de usuário">
            <button onclick="setUsername()">Definir Nome de Usuário</button>
        </div>

        <!-- Seção de Seleção de Categoria -->
        <div id="category-select-section" class="section">
            <h2>Selecione uma Aula</h2>
            <div id="category-buttons-container"></div>
            <button id="create-category-button" onclick="showCreateCategorySection()" style="display: none;">
                Criar Nova Aula
            </button>
        </div>

<!-- Seção de Criação de Categoria -->
<div id="create-category-section" class="section">
    <h2>Criar Nova Aula</h2>
    <input type="text" id="new-category-name" placeholder="Nome da Aula" aria-label="Nome da Aula">
    <input type="datetime-local" id="publication-date" aria-label="Data e Hora de Publicação">
    <input type="file" id="category-icon-upload" aria-label="Upload do Ícone da Aula">
    <button onclick="addCategory()">Criar Aula</button>
    <button id="back-to-category-selector" onclick="showCategorySelector()">Voltar à Seleção de Aula</button>
</div>




        <!-- Seção de Postagens -->
        <div id="posts-container" class="section" style="display: none;">
            <button id="back-button" onclick="showCategorySelector()">Voltar à Seleção de Aula</button>
            <div id="posts-content"></div>
        </div>

        <!-- Botão para criar uma nova postagem -->
<button id="new-post-button" onclick="showCreatePostSection()" style="display: none;">Nova Pergunta</button>

<!-- Seção de criação de postagem (inicialmente oculta) -->
<div id="create-post-section" class="section" style="display: none;">
    <h2>Criar Nova Pergunta</h2>
    <div id="preview-container"></div>
    <input type="text" id="post-title" placeholder="Título da Pergunta" aria-label="Título da Pergunta" />
    <div id="editor-container" aria-label="Editor de conteúdo"></div>
    <button onclick="previewContent()">Prever</button>
    <button id="add-post-button">Criar Pergunta</button>
    <button id="cancel_create_question">Cancelar</button>
</div>

<div id="post-details" class="section" style="display: none;">
        <h2 id="post-title-preview"></h2>
        <p id="post-author-date"></p>
        <p id="post-content"></p>
    <div id="comments-section">
        <h3 id="comments_title">Respostas</h3>
        <div id="comments-container"></div>
        <button onclick="toggleCommentSection()" id="comment_button">Responder</button>
        <div id="comment-tools" style="display: none;">
            <button onclick="previewContentComments()">Prever</button>
            <div id="preview-container-2"></div>
            <input type="text" id="comment-title" placeholder="Título do Comentário" value=''/>
            <div id="comment-input"></div>
            <button id="answer_button">Enviar Resposta</button>
            <button onclick="backToPostDetails()">Voltar</button>
        </div>
    </div>
    <button onclick="showPostsMenu()" id="back-to-posts">Voltar para Perguntas</button>
</div>



    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>

let contextMenuListenerAdded = false;

const firebaseConfig = {
            apiKey: "AIzaSyD4XHaigE5Q5cHwH1SetPa8kAMGe_gpxNM",
            authDomain: "gameficacao-de81c.firebaseapp.com",
            databaseURL: "https://gameficacao-de81c-default-rtdb.firebaseio.com",
            projectId: "gameficacao-de81c",
            storageBucket: "gameficacao-de81c.appspot.com",
            messagingSenderId: "56859269914",
            appId: "1:56859269914:web:b4a7af7a8aa94a873aaaa3"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

function showPostsMenu() {
    document.getElementById('post-details').style.display = 'none';
    document.getElementById('posts-container').style.display = 'block';
    var botao_postagem = document.getElementById('new-post-button');
    botao_postagem.style.display = 'block';
}

let commentQuill; // Declare a variable to hold the Quill instance


function tituloRespostaPadrao() {
    var comment_title = document.getElementById('comment-title');
    comment_title.value = `Re: ${post_title.textContent}`;
}
var post_title;

function toggleCommentSection() {
    post_title = document.getElementById('post-title-preview');
    const postDetailsSection = document.getElementById('post-details');
    const commentTools = document.getElementById('comment-tools');
    const commentInput = document.getElementById('comment-input');
    const backToPosts = document.getElementById('back-to-posts');
    var comments_title = document.getElementById('comments_title');
    var comment_button = document.getElementById('comment_button');

    backToPosts.style.display = 'none';

    if (commentTools.style.display === 'none') {
        commentTools.style.display = 'block';
        postDetailsSection.querySelector('#post-title-preview').style.display = 'none';
        postDetailsSection.querySelector('#post-author-date').style.display = 'none';
        postDetailsSection.querySelector('#post-content').style.display = 'none';
        document.getElementById('comments-container').style.display = 'none';
        comments_title.style.display = 'none';
        comment_button.style.display = 'none';
        tituloRespostaPadrao();

        // Initialize Quill if not already initialized
        if (!commentQuill) {
            commentQuill = new Quill('#comment-input', {
  theme: 'snow',
  modules: {
    toolbar: [
      [{ 'header': [1, 2, false] }],
      ['bold', 'italic', 'underline'],
      [{'list': 'ordered'}, {'list': 'bullet'}],
      ['link', 'image'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'align': [] }]
    ]
  }
});
        }
    } else {
        commentTools.style.display = 'none';
        postDetailsSection.querySelector('#post-title-preview').style.display = 'block';
        postDetailsSection.querySelector('#post-author-date').style.display = 'block';
        postDetailsSection.querySelector('#post-content').style.display = 'block';
        document.getElementById('comments-container').style.display = 'block';
        comments_title.style.display = 'block';
        comment_button.style.display = 'block';
        
        // Optionally, you might want to destroy the Quill instance here if it's not needed
    }
}


function backToPostDetails() {
    const postDetailsSection = document.getElementById('post-details');
    const commentTools = document.getElementById('comment-tools');
    var comments_title = document.getElementById('comments_title');
    var comment_button = document.getElementById('comment_button');
    
    comment_button.style.display = 'block';
    comments_title.style.display = 'block';
    commentTools.style.display = 'none';
    postDetailsSection.querySelector('#post-title-preview').style.display = 'block';
    postDetailsSection.querySelector('#post-author-date').style.display = 'block';
    postDetailsSection.querySelector('#post-content').style.display = 'block';
    document.getElementById('comments-container').style.display = 'block';
    var back_to_posts = document.getElementById('back-to-posts');
    back_to_posts.style.display = 'block';
}

function previewContentComments() {
    const content = commentQuill.root.innerHTML;
    document.getElementById('preview-container-2').innerHTML = content;
}


function generateRandomHue() {
    return Math.floor(Math.random() * 360);
}

function generateHarmonicColor(hue, saturation, lightness) {
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

function calculateTextColor(backgroundColor) {
    const hslMatch = backgroundColor.match(/hsl\((\d+), (\d+)%, (\d+)%\)/);
    if (!hslMatch) return '#000000'; // Retorna preto se não for possível converter

    const h = parseInt(hslMatch[1]);
    const s = parseInt(hslMatch[2]) / 100;
    const l = parseInt(hslMatch[3]) / 100;

    const a = s * Math.min(l, 1 - l);
    const f = n => {
        const k = (n + h / 30) % 12;
        const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
        return Math.round(255 * color);
    };

    const rgb = [f(0), f(8), f(4)];
    const luminance = (0.2126 * rgb[0] + 0.7152 * rgb[1] + 0.0722 * rgb[2]) / 255;
    return luminance > 0.5 ? '#000000' : '#ffffff';
}

function applyHarmonicColors() {
    const baseHue = generateRandomHue();
    const highlightHue = (baseHue + 180) % 360;
    const saturation = 80;

    const backgroundColor = generateHarmonicColor(baseHue, saturation, 90);
    const containerBackgroundColor = generateHarmonicColor(baseHue, saturation, 80);
    const buttonBackgroundColor = generateHarmonicColor(highlightHue, saturation, 60);
    const googleButtonBackgroundColor = generateHarmonicColor(highlightHue, saturation, 60);
    const notificationErrorBackgroundColor = generateHarmonicColor(highlightHue, saturation, 70);
    const notificationSuccessBackgroundColor = generateHarmonicColor(highlightHue, saturation, 60);
    const categoryButtonBackgroundColor = generateHarmonicColor(baseHue, saturation, 80);
    const categoryButtonBorderColor = generateHarmonicColor(highlightHue, saturation, 60); // Nova cor para a borda
    const postBorderColor = generateHarmonicColor(highlightHue, saturation, 60);
    const headerBackgroundColor = generateHarmonicColor(baseHue, saturation, 75);
    const logoColor = generateHarmonicColor(highlightHue, saturation, 50); // Cor da logo

    document.documentElement.style.setProperty('--background-color', backgroundColor);
    document.documentElement.style.setProperty('--text-color', calculateTextColor(backgroundColor));
    document.documentElement.style.setProperty('--container-background-color', containerBackgroundColor);
    document.documentElement.style.setProperty('--button-background-color', buttonBackgroundColor);
    document.documentElement.style.setProperty('--google-button-background-color', googleButtonBackgroundColor);
    document.documentElement.style.setProperty('--input-border-color', generateHarmonicColor(baseHue, saturation, 30));
    document.documentElement.style.setProperty('--notification-error-background-color', notificationErrorBackgroundColor);
    document.documentElement.style.setProperty('--notification-success-background-color', notificationSuccessBackgroundColor);
    document.documentElement.style.setProperty('--category-button-background-color', categoryButtonBackgroundColor);
    document.documentElement.style.setProperty('--category-button-border-color', categoryButtonBorderColor); // Adicionando a nova variável
    document.documentElement.style.setProperty('--post-border-color', postBorderColor);
    document.documentElement.style.setProperty('--header-background-color', headerBackgroundColor);
    document.documentElement.style.setProperty('--logo-color', logoColor); // Adicionando cor da logo

    document.documentElement.style.setProperty('--button-text-color', calculateTextColor(buttonBackgroundColor));
    document.documentElement.style.setProperty('--google-button-text-color', calculateTextColor(googleButtonBackgroundColor));
    document.documentElement.style.setProperty('--notification-error-text-color', calculateTextColor(notificationErrorBackgroundColor));
    document.documentElement.style.setProperty('--notification-success-text-color', calculateTextColor(notificationSuccessBackgroundColor));
    document.documentElement.style.setProperty('--category-button-text-color', calculateTextColor(categoryButtonBackgroundColor));
    document.documentElement.style.setProperty('--post-link-color', calculateTextColor(generateHarmonicColor(highlightHue, saturation, 60)));
}

document.addEventListener('DOMContentLoaded', applyHarmonicColors);

// Função para converter data e hora no horário de Brasília para UTC
function parseBrasiliaDate(dateStr) {
    const [day, month, year, hour, minute] = dateStr.split(/[/ :]/).map(Number);
    return new Date(Date.UTC(year, month - 1, day, hour + 3, minute));
}

// Função para formatar a data e hora no fuso horário de Brasília
function formatDateToBrasilia(date) {
    return new Intl.DateTimeFormat('pt-BR', {
        timeZone: 'America/Sao_Paulo',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: false
    }).format(date);
}

// Função para obter a data formatada como YYYY-MM-DD
function getFormattedDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

function formatDateToISO(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
}

async function checkUserPresence() {
    const user = auth.currentUser;
    if (!user) {
        console.error('Usuário não está autenticado.');
        return;
    }

    const userId = user.uid;
    const now = new Date();

    try {
        // Recupera todas as datas de aulas do banco de dados
        const aulasSnapshot = await db.ref('aulas').orderByKey().once('value');
        const aulas = aulasSnapshot.val();

        if (aulas) {
            for (const dateKey in aulas) {
                if (aulas.hasOwnProperty(dateKey)) {
                    const horarios = aulas[dateKey];
                    const intervalStart = new Date(horarios.comeca);
                    const intervalEnd = new Date(horarios.acaba);

                    let estado = '';
                    let presente = null;

                    if (now > intervalEnd) {
                        estado = 'passado';
                        presente = false;
                    } else if (now >= intervalStart && now <= intervalEnd) {
                        estado = 'presente';
                        presente = true;
                    } else if (now < intervalStart) {
                        estado = 'futuro';
                        presente = null;
                    }

                    if (estado) {
                        const userPresenceRef = db.ref(`users/${userId}/${dateKey}`);
                        
                        // Verifica se já existe um registro de presença
                        const userPresenceSnapshot = await userPresenceRef.once('value');
                        if (!userPresenceSnapshot.exists()) {
                            await userPresenceRef.set({
                                presente: presente
                            });
                        }
                    }
                }
            }
        } else {
            console.error('Nenhuma aula encontrada.');
        }
    } catch (error) {
        console.error('Erro ao verificar presença:', error);
    }
}


function formatDateToISO(date) {
    return date.toISOString().split('T')[0];
}


async function verificarChamada() {
    if (!isAdmin) {
        console.log('Acesso negado: somente administradores podem executar este comando.');
        return;
    }
    try {
        const now = new Date();
        console.log('Data e hora atuais:', now);

        // Recupera todas as datas de aulas do banco de dados
        const aulasSnapshot = await db.ref('aulas').orderByKey().once('value');
        const aulas = aulasSnapshot.val();
        console.log('Aulas recuperadas:', aulas);

        if (aulas) {
            for (const dateKey in aulas) {
                if (aulas.hasOwnProperty(dateKey)) {
                    const horarios = aulas[dateKey];
                    const intervalEnd = new Date(horarios.acaba);
                    console.log(`Verificando aula com chave ${dateKey}. Data final: ${intervalEnd}`);

                    // Verifica se a data está no passado
                    if (now > intervalEnd) {
                        console.log(`Data ${intervalEnd} está no passado. Processando...`);

                        // Recupera todos os usuários
                        const usersSnapshot = await db.ref('users').once('value');
                        const users = usersSnapshot.val();
                        console.log('Usuários recuperados:', users);

                        for (const userId in users) {
                            if (users.hasOwnProperty(userId)) {
                                const userPresenceRef = db.ref(`users/${userId}/${dateKey}`);

                                // Verifica se a presença já existe
                                const presenceSnapshot = await userPresenceRef.once('value');
                                console.log(`Verificando presença do usuário ${userId} para a data ${dateKey}`);

                                if (!presenceSnapshot.exists()) {
                                    // Se não existir, cria e marca como false
                                    console.log(`Presença não encontrada para ${userId} na data ${dateKey}. Criando entrada com 'presente: false'.`);
                                    await userPresenceRef.set({
                                        presente: false
                                    });
                                } else {
                                    console.log(`Presença já existente para ${userId} na data ${dateKey}.`);
                                }
                            }
                        }
                    } else {
                        console.log(`Data ${intervalEnd} ainda não passou. Ignorando...`);
                    }
                }
            }
        } else {
            console.error('Nenhuma aula encontrada.');
        }
    } catch (error) {
        console.error('Erro ao verificar e marcar presença para datas passadas:', error);
    }
}

    /// Código de monitoramento de atividade do usuário
    let lastVisibleTime = null;
        let log = [];

        function handleVisibilityChange() {
            const currentTime = new Date();
            if (document.hidden) {
                // A guia foi escondida
                lastVisibleTime = currentTime;
                logUserActivity({ action: 'saiu', timestamp: formatDateToBrasilia(currentTime) });
            } else {
                // A guia foi mostrada
                if (lastVisibleTime) {
                    logUserActivity({ action: 'retornou', timestamp: formatDateToBrasilia(currentTime) });
                } else {
                    logUserActivity({ action: 'entrou', timestamp: formatDateToBrasilia(currentTime) });
                }
                lastVisibleTime = null;
            }
            logUserActivity(log);
        }

        function logUserActivity(logEntry) {
    const user = firebase.auth().currentUser;
    if (user) {
        const currentTime = new Date();
        const currentDate = getFormattedDate(currentTime);
        const userActivityRef = firebase.database().ref(`users/${user.uid}/log/${currentDate}`);

        // Adicionar o log
        userActivityRef.push(logEntry)
            .catch(error => {
                console.error('Erro ao registrar a atividade do usuário: ', error);
            });
    }
}


        document.addEventListener('visibilitychange', handleVisibilityChange);

        // Inicializa o log ao carregar a página
        window.addEventListener('load', () => {
            const currentTime = new Date();
            logUserActivity({ action: 'entrou', timestamp: formatDateToBrasilia(currentTime) });

            updateUserInfo();
        });

        window.addEventListener('beforeunload', () => {
            handleVisibilityChange();
        });

        function showNotification(message, isError = false) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.toggle('error', isError);
            notification.classList.toggle('success', !isError);
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        function showCreateCategorySection() {
            toggleSections('create-category-section');
        }



// Função para mostrar a seção de criação de postagem e adicionar o event listener
function showCreatePostSection() {
    document.getElementById('create-post-section').style.display = 'block';
    document.getElementById('new-post-button').style.display = 'none'; // Ocultar o botão "Nova Postagem"

}

// Atualizar a função para mostrar as postagens e adicionar o event listener
function loadPostsForCategory(categoryId) {
    const postsContainer = document.getElementById('posts-content');
    postsContainer.innerHTML = '';

    db.ref('categories/' + currentCategoryId + '/posts/').once('value', snapshot => {
        if (snapshot.exists()) {
            const posts = snapshot.val();
            Object.keys(posts).forEach(postId => {
                const post = posts[postId];
                const postElement = createPostElement(post, postId, categoryId);
                postsContainer.appendChild(postElement);
            });
        } else {
            postsContainer.innerHTML = '<p>Nenhuma postagem encontrada.</p>';
        }

        toggleSections('posts-container', true);
        var voltar = document.getElementById('back-button');
        voltar.style.display = 'block';
        if (voltar) {
            voltar.addEventListener('click', () => {
                newPostButton.style.display = 'none';
            });
        }

        // Adiciona o event listener ao botão "Nova Postagem"
        const newPostButton = document.getElementById('new-post-button');
        newPostButton.style.display = 'block';
        if (newPostButton) {
            newPostButton.addEventListener('click', () => {
                showCreatePostSection();
                newPostButton.style.display = 'none';
            });
        }
    }).catch(error => {
        showNotification('Erro ao carregar postagens: ' + error.message, true);
    });
}

async function hideCreatePostSection(acao, postId = null) {
    if (acao === 'y') {
        document.getElementById('create-post-section').style.display = 'none';
        document.getElementById('new-post-button').style.display = 'block';
        clearCreatePostSection();  
        loadPostsForCategory(currentCategoryId); 
    } else if (acao === 'n' && postId) {
        document.getElementById('create-post-section').style.display = 'none';
        clearCreatePostSection();  

        // Aguarde o resultado da função getPostData
        const resultado = await getPostData(currentCategoryId, postId);

        // Passe o resultado não Promise para showPostDetails
        showPostDetails(resultado, postId);
    }
}


async function getPostData(currentCategoryId, postId) {
    try {
        // Criando a referência ao caminho desejado
        const postRef = db.ref('categories/' + currentCategoryId + '/posts/' + '/' + postId);

        // Obtendo os dados da referência
        const snapshot = await postRef.once('value');
        
        // Verificando se a snapshot possui dados
        if (snapshot.exists()) {
            const postData = snapshot.val();
            return postData;
        } else {
            console.error('Nenhum dado encontrado no caminho.');
            return null;
        }
    } catch (error) {
        console.error('Erro ao obter os dados:', error);
    }
}

function clearCreatePostSection() {
    document.getElementById('post-title-preview').value = '';
    if (window.quill) {
        window.quill.root.innerHTML = '';
    }
    document.getElementById('preview-container').innerHTML = '';
}

function createPostElement(post, postId, categoryId) {
    const postElement = document.createElement('div');
    postElement.classList.add('post');

    // Cria o título da postagem
    const postTitle = document.createElement('h2');
    postTitle.textContent = post.title;
    postTitle.classList.add('post-title');
    postElement.appendChild(postTitle);

    // Cria o autor e a data da postagem
    const postInfo = document.createElement('p');
    postInfo.textContent = `Autor: ${post.authorName} | Data: ${new Date(post.timestamp).toLocaleDateString()}`;
    postInfo.classList.add('post-info');
    postElement.appendChild(postInfo);

    // Adiciona o evento de clique para mostrar os detalhes da postagem
    postElement.onclick = function() {
        showPostDetails(post, postId);
    };

    return postElement;
}

document.getElementById('reset-password-link').addEventListener('click', function() {
  var email = prompt('Por favor, insira seu email:');

  if (email) {
    firebase.auth().sendPasswordResetEmail(email)
      .then(function() {
        alert('Email de redefinição de senha enviado!');
      })
      .catch(function(error) {
        var errorCode = error.code;
        var errorMessage = error.message;
        // Mostre o erro para o usuário
        alert('Erro ao enviar email de redefinição de senha: ' + errorMessage);
      });
  }
});


async function addCategory() {
    const categoryName = document.getElementById('new-category-name').value.trim();
    const publicationDate = document.getElementById('publication-date').value;
    const iconFile = document.getElementById('category-icon-upload').files[0]; // Arquivo selecionado

    if (categoryName === '') {
        showNotification('O nome da categoria é obrigatório.', true);
        return;
    }

    let iconUrl = null;
    if (iconFile) {
        // Cria um nome único para o arquivo
        const iconFileName = 'icons/' + Date.now() + '-' + iconFile.name;
        const storageRef = firebase.storage().ref().child(iconFileName);

        try {
            // Faz o upload do arquivo
            await storageRef.put(iconFile);
            // Obtém a URL do arquivo
            iconUrl = await storageRef.getDownloadURL();
        } catch (error) {
            showNotification('Erro ao fazer upload do ícone: ' + error.message, true);
            return;
        }
    }

    const categoryData = {
        name: categoryName,
        publicationDate: publicationDate ? new Date(publicationDate).toISOString() : null,
        iconUrl: iconUrl // Inclui o ícone na categoria
    };

    db.ref('categories').push(categoryData, error => {
        if (error) {
            showNotification('Erro ao criar categoria: ' + error.message, true);
        } else {
            showNotification('Categoria criada com sucesso!');
            document.getElementById('new-category-name').value = '';
            document.getElementById('publication-date').value = '';
            document.getElementById('category-icon-upload').value = ''; // Limpa o campo de upload
            loadCategories();
            showCategorySelector();
        }
    });
}




        function showLogin() {
            toggleSections('login-section');
        }

        function showRegistration() {
            toggleSections('registration-section');
        }

        let currentUsername = 'Usuário'; // Variável global para armazenar o nome do usuário


var isAdmin = false;
async function updateUserInfo() {
    const user = auth.currentUser;
    if (user) {
        try {
            const userSnapshot = await db.ref('users/' + user.uid).once('value');
            const userData = userSnapshot.val();
            currentUsername = userData ? userData.username : 'Usuário'; // Armazena o nome de usuário globalmente
            const isAdmin = userData ? userData.admin : false;

            if (isAdmin) {
                enableAdmin();
            }

            document.getElementById('user-name').textContent = currentUsername;
            document.getElementById('create-category-button').style.display = isAdmin ? 'block' : 'none';
            checkUserPresence();
        } catch (error) {
            showNotification('Erro ao atualizar informações do usuário: ' + error.message, true);
        }
    }
}

function enableAdmin() {
    isAdmin = true;
    consoleControl(isAdmin);
    loadCategories();
}

document.addEventListener('copy', function(event) {
    // Verifica se o conteúdo copiado é uma imagem
    if (event.clipboardData && event.clipboardData.items) {
        for (let item of event.clipboardData.items) {
            if (item.type.startsWith('image/')) {
                alert('Imagem copiada com sucesso!');
                return;
            }
        }
    }
});



consoleControl(false);


        function showCategorySelector() {
            toggleSections('category-select-section', true);
            if (currentUsername !== 'Usuário') {
                document.getElementById('user-info').style.display = 'block';
            }
            updateUserInfo();
            loadCategories();
        }

        function showCreatePostSection() {
            toggleSections('create-post-section');
        }

        var quill = new Quill('#editor-container', {
  theme: 'snow',
  modules: {
    toolbar: [
      [{ 'header': [1, 2, false] }],
      ['bold', 'italic', 'underline'],
      [{'list': 'ordered'}, {'list': 'bullet'}],
      ['link', 'image'],
      [{ 'color': [] }, { 'background': [] }],
      [{ 'align': [] }]
    ]
  }
});


async function addPost(categoryId, acao, postId = null) {
    const title = document.getElementById('post-title').value;
    const content = quill.root.innerHTML;  // Use o conteúdo gerado pelo Quill

    if (title.trim() === '' || content.trim() === '') {
        showNotification('Título e conteúdo são obrigatórios.', true);
        return;
    }

    const user = auth.currentUser;
    if (!user) {
        showNotification('Você deve estar logado para criar uma postagem.', true);
        return;
    }

    try {
        const userSnapshot = await db.ref('users/' + user.uid).once('value');
        const userData = userSnapshot.val();
        const authorName = userData ? userData.username : 'Anônimo';

        if (acao === 'y') {
            // Criar nova postagem
            const newPostRef = db.ref('categories/' + currentCategoryId + '/posts/').push();
            await newPostRef.set({
                title: title,
                content: content,
                authorId: user.uid,
                authorName: authorName,
                timestamp: new Date().toISOString()
            });
            showNotification('Postagem criada com sucesso!');
        } else if (acao === 'n' && postId) {
            // Atualizar postagem existente
            await db.ref('categories/' + currentCategoryId + '/posts/' + '/' + postId).update({
                title: title,
                content: content,
                authorId: user.uid,
                authorName: authorName,
                timestamp: new Date().toISOString()
            });
            showNotification('Postagem editada com sucesso!');
        }

        loadPostsForCategory(categoryId);
    } catch (error) {
        showNotification('Erro ao criar ou editar postagem: ' + error.message, true);
    }
}


function previewContent() {
    const content = quill.root.innerHTML;
    document.getElementById('preview-container').innerHTML = content;
}

function previewContentComments() {
    const content = commentQuill.root.innerHTML;
    document.getElementById('preview-container-2').innerHTML = content;
}


function loadPosts(categoryId) {
    db.ref('categories/' + categoryId + '/posts').once('value', function(snapshot) {
        const postsContainer = document.getElementById('posts-content');
        postsContainer.innerHTML = '';
        snapshot.forEach(function(postSnapshot) {
            const post = postSnapshot.val();
            const postButton = document.createElement('button');
            postButton.textContent = `${post.title} - ${post.authorName} (${new Date(post.timestamp).toLocaleDateString()})`;
            postButton.onclick = function() {
                showPostDetails(categoryId, postSnapshot.key);
            };
            postsContainer.appendChild(postButton);
        });
    });
    document.getElementById('posts-container').style.display = 'block';
    document.getElementById('post-details').style.display = 'none';
}



let currentPostId;
function showPostDetails(post, postId) {
    currentPostId = postId;
    const postDetailsSection = document.getElementById('post-details');
    postDetailsSection.querySelector('#post-title-preview').textContent = post.title;
    postDetailsSection.querySelector('#post-author-date').textContent = `Autor: ${post.authorName} | Publicado em: ${new Date(post.timestamp).toLocaleString()}`;
    criarEditarPostagem(post, postId, postDetailsSection);
    postDetailsSection.querySelector('#post-content').innerHTML = post.content;
    var botao_postagem = document.getElementById('new-post-button');
    botao_postagem.style.display = 'none';

    postDetailsSection.style.display = 'block';

    document.getElementById('posts-container').style.display = 'none';

    // Carregar comentários existentes
    loadComments(postId);
}

async function criarEditarPostagem(post, postId, postDetailsSection) {
    var user = auth.currentUser;
    const userInfo = (await db.ref('users/' + user.uid).once('value')).val();
        
    if (userInfo.username === post.authorName) {
    // Verifica se o botão já foi adicionado
    const existingButton = postDetailsSection.querySelector('#post-author-date .edit-button');
    if (!existingButton) {
        // Cria e adiciona uma quebra de linha
        const br = document.createElement('br');
        postDetailsSection.querySelector('#post-author-date').appendChild(br);

        // Cria e adiciona o botão de editar resposta
        const button = document.createElement('button');
        button.classList.add('edit-button'); // Adiciona uma classe para identificação
        button.innerHTML = 'Editar resposta';
        button.onclick = function() {
            editarPostagem(postId);
        };

        postDetailsSection.querySelector('#post-author-date').appendChild(button);
    }
}
}

// Função que é chamada quando o botão de criar postagem é clicado
function criarPostHandler() {
    addPost(currentCategoryId, 'y');
    removerEventos(); // Remove o listener após a execução
}

function voltarCriarPost() {
    hideCreatePostSection('y');
    // Restaurar os eventos para criação de postagem
    restaurarEventos();
}

function voltarEditarPost(postId) {
    hideCreatePostSection('n', postId);
    // Restaurar os eventos para edição de postagem
    restaurarEventos();
}

// Função que é chamada quando o botão de criar postagem é clicado para editar
function editarPostHandler(postId) {
    addPost(currentCategoryId, 'n', postId);
    removerEventos(); // Remove o listener após a execução
}

// Função para remover os eventos dos botões
function removerEventos() {
    var botao_criar_postagem = document.getElementById('add-post-button');
    var cancel_create_question = document.getElementById('cancel_create_question');

    if (botao_criar_postagem) {
        botao_criar_postagem.removeEventListener('click', criarPostHandler);
        botao_criar_postagem.removeEventListener('click', editarPostHandler);
    }

    if (cancel_create_question) {
        cancel_create_question.removeEventListener('click', voltarCriarPost);
        cancel_create_question.removeEventListener('click', voltarEditarPost);
    }
}

// Função para restaurar os eventos
function restaurarEventos() {
    var botao_criar_postagem = document.getElementById('add-post-button');
    var cancel_create_question = document.getElementById('cancel_create_question');

    if (botao_criar_postagem) {
        // Adiciona o manipulador de evento original para criação de postagem
        botao_criar_postagem.addEventListener('click', criarPostHandler);
    }

    if (cancel_create_question) {
        // Adiciona o manipulador de evento original para voltar à criação de postagem
        cancel_create_question.addEventListener('click', voltarCriarPost);
    }
}

// Adicionar o manipulador de evento inicial
function configurarEventosIniciais() {
    var botao_criar_postagem = document.getElementById('add-post-button');
    var cancel_create_question = document.getElementById('cancel_create_question');

    if (botao_criar_postagem) {
        botao_criar_postagem.addEventListener('click', criarPostHandler);
    }

    if (cancel_create_question) {
        cancel_create_question.addEventListener('click', voltarCriarPost);
    }
}

// Função para ativar a edição de postagem
function editarPostagem(postId) {
    showCreatePostSection();
    removerEventos(); // Remove eventos existentes

    var botao_criar_postagem = document.getElementById('add-post-button');
    var cancel_create_question = document.getElementById('cancel_create_question');

    if (botao_criar_postagem) {
        // Adiciona o novo manipulador de evento para edição
        botao_criar_postagem.addEventListener('click', () => {
            editarPostHandler(postId);
        });
    }

    if (cancel_create_question) {
        cancel_create_question.addEventListener('click', () => {
            voltarEditarPost(postId);
        });
    }
}

// Configurar eventos iniciais
configurarEventosIniciais();




function addComment(postId, action, commentId = null) {
    const commentTitle = document.getElementById('comment-title').value; // Obter o título do comentário
    const commentContent = commentQuill.root.innerHTML;
    const timestamp = new Date().toISOString(); // Data e hora atuais

    // Verificar se o nome do usuário está definido
    const authorName = currentUsername || 'Usuário'; // Usar o nome do usuário armazenado globalmente

    if (commentContent.trim() !== '<p><br></p>' && commentTitle.trim() !== '') { // Verifica se o conteúdo e o título não estão vazios
        if (action === 'y') {
            // Novo comentário
            const newCommentRef = db.ref('categories/' + currentCategoryId + '/posts/' + postId + '/comments').push();
            newCommentRef.set({
                title: commentTitle,
                text: commentContent,
                author: authorName,
                timestamp: timestamp
            }, function(error) {
                if (error) {
                    showNotification('Erro ao adicionar comentário.', true);
                } else {
                    showNotification('Comentário adicionado com sucesso.', false);
                    document.getElementById('comment-title').value = ''; // Limpa o título
                    backToPostDetails();
                    commentQuill.root.innerHTML = ''; // Limpa o editor Quill
                    loadComments(postId); // Atualiza a lista de comentários
                }
            });
        } else if (action === 'n' && commentId) {
            // Editar comentário existente
            const commentRef = db.ref('categories/' + currentCategoryId + '/posts/' + postId + '/comments/' + commentId);
            commentRef.update({
                title: commentTitle,
                text: commentContent,
                author: authorName,
                timestamp: timestamp
            }, function(error) {
                if (error) {
                    showNotification('Erro ao editar comentário.', true);
                } else {
                    showNotification('Comentário editado com sucesso.', false);
                    document.getElementById('comment-title').value = ''; // Limpa o título
                    backToPostDetails();
                    commentQuill.root.innerHTML = ''; // Limpa o editor Quill
                    loadComments(postId); // Atualiza a lista de comentários
                }
            });
            var answerButton = document.getElementById('answer_button');
            answerButton.onclick = function() {
            addComment(currentPostId, 'y');
            };    
        } else {
            showNotification('Ação inválida ou ID do comentário não fornecido.', true);
        }
    } else {
        showNotification('O comentário e o título não podem estar vazios.', true);
    }
}


async function criarEditarComentario(comment, commentHeader, commentId) {
    var user = auth.currentUser;
    const userInfo = (await db.ref('users/' + user.uid).once('value')).val();
        
    if (userInfo.username == comment.author) {
        commentHeader.innerHTML += `<br><button onclick='(function() { editarComentario("${commentId}"); })()'>Editar resposta</button>`;
    }
}

var answerButton = document.getElementById('answer_button');
    answerButton.onclick = function() {
            addComment(currentPostId, 'y');
        };

function editarComentario(commentId) {
    var answerButton = document.getElementById('answer_button');
    answerButton.onclick = function() {
            addComment(currentPostId, 'n', commentId);
        };
    toggleCommentSection();
} 

function loadComments(postId) {
    const commentsContainer = document.getElementById('comments-container');
    commentsContainer.innerHTML = ''; // Limpa os comentários antigos

    db.ref('categories/' + currentCategoryId + '/posts/' + postId + '/comments').on('value', function(snapshot) {
        snapshot.forEach(function(childSnapshot) {
            const comment = childSnapshot.val();
            const commentId = childSnapshot.key;

            const commentWrapper = document.createElement('div');
            commentWrapper.classList.add('comment-wrapper');
            
            // Adiciona o título, autor e data
            const commentHeader = document.createElement('div');
            commentHeader.classList.add('comment-header');
            commentHeader.innerHTML = `<strong>${comment.title}</strong> - ${comment.author} - ${new Date(comment.timestamp).toLocaleString()}`;
            criarEditarComentario(comment, commentHeader, commentId);


            const commentQuillDiv = document.createElement('div');
            commentQuillDiv.id = 'comment-' + commentId;

            commentWrapper.appendChild(commentHeader);
            commentWrapper.appendChild(commentQuillDiv);
            commentsContainer.appendChild(commentWrapper);

            const commentQuill = new Quill('#comment-' + commentId, {
                theme: 'bubble',
                readOnly: true,
                modules: {
                    toolbar: false
                }
            });

            commentQuill.root.innerHTML = comment.text;
        });
    });
}



        let currentCategoryId = null;

        function showPosts(category) {
            currentCategoryId = category;

            if (!currentCategoryId) {
                showNotification('Categoria não definida.', true);
                return;
            }

            const postsContainer = document.getElementById('posts-content');
            if (!postsContainer) {
                showNotification('Erro ao acessar o contêiner de postagens.', true);
                return;
            }

            postsContainer.innerHTML = '';

            db.ref('categories/' + currentCategoryId + '/posts/' + category).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const posts = snapshot.val();
                    Object.keys(posts).forEach(postId => {
                        const post = posts[postId];
                        const postElement = createPostElement(post, postId, category);
                        postsContainer.appendChild(postElement);
                    });
                } else {
                    postsContainer.innerHTML = '<p>Nenhuma postagem encontrada.</p>';
                }

                toggleSections('posts-container', true);
                document.getElementById('create-post-section').style.display = 'block';
                document.getElementById('back-button').style.display = 'block';
            }).catch(error => {
                showNotification('Erro ao carregar postagens: ' + error.message, true);
            });
        }

        async function setUsername() {
            const newUsername = document.getElementById('new-username').value;
            const user = auth.currentUser;

            if (newUsername.trim() === '') {
                showNotification('Nome de usuário é obrigatório.', true);
                return;
            }

            try {
                await db.ref('users/' + user.uid).set({
                    username: newUsername,
                    email: user.email
                });

                showNotification('Nome de usuário definido com sucesso!');
                updateUserInfo();
                showCategorySelector();
            } catch (error) {
                showNotification('Erro ao definir nome de usuário: ' + error.message, true);
            }
        }

        function showSetUsername() {
            toggleSections('set-username-section');
        }

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).then(result => {
                const user = result.user;
                db.ref('users/' + user.uid).once('value').then(snapshot => {
                    if (!snapshot.exists()) {
                        showSetUsername();
                    } else {
                        showNotification('Login com Google realizado com sucesso!');
                        updateUserInfo();
                        showCategorySelector();
                    }
                }).catch(error => {
                    showNotification('Erro ao verificar usuário: ' + error.message, true);
                });
            }).catch(error => {
                showNotification('Erro ao fazer login com Google: ' + error.message, true);
            });
        }

        async function logout() {
            try {
                await auth.signOut();
                showNotification('Logout realizado com sucesso!');
                showLogin();
            } catch (error) {
                showNotification('Erro ao fazer logout: ' + error.message, true);
            }
        }

        async function register() {
    const username = document.getElementById('register-username').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;

    if (username.trim() === '' || email.trim() === '' || password.trim() === '') {
        showNotification('Todos os campos são obrigatórios.', true);
        return;
    }

    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        await db.ref('users/' + user.uid).set({
            username: username,
            email: email,
            admin: false
        });

        showNotification('Usuário registrado com sucesso! Faça login para continuar.');
        showLogin();
    } catch (error) {
        showNotification('Erro ao registrar usuário: ' + error.message, true);
    }
}

async function login() {
    const usernameOrEmail = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;

    if (usernameOrEmail.trim() === '' || password.trim() === '') {
        showNotification('Nome de usuário/Email e senha são obrigatórios.', true);
        return;
    }

    try {
        let email;
        const userSnapshot = await db.ref('users').orderByChild('username').equalTo(usernameOrEmail).once('value');
        if (userSnapshot.exists()) {
            email = Object.values(userSnapshot.val())[0].email;
        } else {
            email = usernameOrEmail;
        }

        if (!email) {
            throw new Error('E-mail não encontrado para o nome de usuário fornecido.');
        }

        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;

        const userInfo = (await db.ref('users/' + user.uid).once('value')).val();

        showNotification('Login realizado com sucesso!');
        showCategorySelector();
    } catch (error) {
        if (error.message === '{"error":{"code":400,"message":"INVALID_LOGIN_CREDENTIALS","errors":[{"message":"INVALID_LOGIN_CREDENTIALS","domain":"global","reason":"invalid"}]}}') {
            showNotification('Erro ao fazer login: Email, nome de usuário ou senha incorretos ou não existentes.', true);
        } else {
            showNotification('Erro ao fazer login: ' + error.message, true);
        }
    }
}

async function realName() {
    const user = auth.currentUser;
    if (!user) {
        console.error('Usuário não está autenticado.');
        return;
    }

    try {
        const userRef = db.ref('users/' + user.uid);
        const userInfoSnapshot = await userRef.once('value');
        const userInfo = userInfoSnapshot.val();

        if (!userInfo || !userInfo.realName) {
            const realName = prompt('Por favor, insira seu nome real:');
            if (realName && realName.trim() !== '') {
                await userRef.update({
                    realName: realName.trim()
                });
                showNotification('Nome real registrado com sucesso!');
            } else {
                showNotification('Nome real não pode estar vazio.', true);
            }
        }
    } catch (error) {
        console.error('Erro ao registrar nome real:', error);
    }
}

auth.onAuthStateChanged(async (user) => {
    if (user) {
        await realName();
    }
});

async function consoleControl(isAdmin) {
    if (!isAdmin) {
        // Desabilitar menu de contexto (clique direito) se ainda não estiver desabilitado
        if (!contextMenuListenerAdded) {
            document.addEventListener('contextmenu', preventDefaultContextMenu);
            contextMenuListenerAdded = true;
        }

        // Bloquear teclas de atalho
        document.onkeydown = function(e) {
            // F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U
            if (
                e.keyCode === 123 ||
                (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                (e.ctrlKey && e.shiftKey && e.keyCode === 74) ||
                (e.ctrlKey && e.keyCode === 85)
            ) {
                e.preventDefault();
                return false;
            }
        };
    } else {
        // Reabilitar menu de contexto (clique direito) se ainda estiver desabilitado
        if (contextMenuListenerAdded) {
            document.removeEventListener('contextmenu', preventDefaultContextMenu);
            contextMenuListenerAdded = false;
        }

        // Reabilitar teclas de atalho
        document.onkeydown = null;
    }
}

function preventDefaultContextMenu(e) {
    e.preventDefault();

    if (event.ctrlKey) {
        event.preventDefault(); // Evita o menu de contexto padrão

        const img = event.target;
        if (img.tagName === 'IMG') {
            const url = img.src;
            const a = document.createElement('a');
            a.href = url;
            a.download = url.substring(url.lastIndexOf('/') + 1); // Nome do arquivo
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
    }
}



auth.onAuthStateChanged(async user => {
    if (user) {
        const userInfo = (await db.ref('users/' + user.uid).once('value')).val();
        
        if (!userInfo.username) {
            showSetUsername();
        }

        if (!userInfo.admin) {
    await db.ref('users/' + user.uid).update({
        admin: false
    });
}


        await updateUserInfo();
        showCategorySelector();
    } else {
        showLogin();
    }
});


    
        function loadCategories() {
    const categoryButtonsContainer = document.getElementById('category-buttons-container');
    const currentDate = new Date().toISOString();
    

    db.ref('categories').once('value').then(snapshot => {
        if (snapshot.exists()) {
            const categories = snapshot.val();
            categoryButtonsContainer.innerHTML = '';

            Object.keys(categories).forEach(categoryId => {
                const category = categories[categoryId];
                const publicationDate = category.publicationDate ? new Date(category.publicationDate).toISOString() : null;

                // Verifica se a categoria já pode ser exibida
                if (isAdmin || !publicationDate || currentDate >= publicationDate) {
                    const button = document.createElement('div');
                    button.classList.add('category-button');
                    
                    // Adiciona o ícone
                    const icon = document.createElement('img');
                    icon.src = category.iconUrl || 'default-icon.png'; // URL do ícone da categoria
                    icon.alt = 'Categoria Icon';
                    icon.classList.add('category-icon');
                    button.appendChild(icon);

                    // Adiciona o nome da categoria
                    const name = document.createElement('span');
                    name.textContent = category.name;
                    name.classList.add('category-name');
                    button.appendChild(name);

                    button.onclick = () => {
                        currentCategoryId = categoryId;
                        loadPostsForCategory(categoryId);
                    };

                    categoryButtonsContainer.appendChild(button);
                }
            });

            document.getElementById('category-select-section').style.display = 'block';
        } else {
            showNotification('Nenhuma categoria encontrada.', true);
        }
    }).catch(error => {
        showNotification('Erro ao carregar categorias: ' + error.message, true);
    });
}



        function toggleSections(sectionToShow, showUserInfo = false) {
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => {
        section.style.display = 'none';
    });
    document.getElementById(sectionToShow).style.display = 'block';

    if (showUserInfo) {
        document.getElementById('user-info').style.display = 'block';
    }
}

    </script>
</body>
</html>
